{% extends 'presupuestos/base.html' %}
{% load static %}

{% block title %}Registro de Transacciones - Sistema de Gesti√≥n Financiera{% endblock %}

{% block subtitle %}Registro de Transacciones{% endblock %}

{% block content %}
<style>
    .filters-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.2);
    }
    
    .transaction-item {
        background: white;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-left: 4px solid #4facfe;
        transition: transform 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .transaction-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .badge-cerrado {
        background: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .badge-abierto {
        background: #f59e0b;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .btn-small {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 5px;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-view {
        background: #4facfe;
        color: white;
    }
    
    .btn-edit {
        background: #f59e0b;
        color: white;
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
    }
    
    .btn-new {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .btn-new:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 10px;
        border: 2px dashed #e5e7eb;
    }
    
    .empty-icon {
        font-size: 3rem;
        color: #9ca3af;
        margin-bottom: 1rem;
    }
</style>

<main class="container">
    <!-- Estad√≠sticas -->
    <div class="stats-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; color: white;">Resumen de Transacciones</h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">
                    Sistema de asignaci√≥n de pagos a presupuestos cerrados
                </p>
            </div>
            <a href="{% url 'presupuestos:crear_transaccion_general' %}" class="btn-new">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                </svg>
                Registrar Nueva Transacci√≥n
            </a>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <div style="font-size: 0.875rem; opacity: 0.9;">Total Transacciones</div>
                <div style="font-size: 2rem; font-weight: 700;">{{ total_transacciones }}</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <div style="font-size: 0.875rem; opacity: 0.9;">Monto Total</div>
                <div style="font-size: 2rem; font-weight: 700;">${{ monto_total|floatformat:0 }}</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <div style="font-size: 0.875rem; opacity: 0.9;">Presupuestos Cerrados</div>
                <div style="font-size: 2rem; font-weight: 700;">{{ presupuestos_cerrados.count }}</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
        <form method="get" id="filterForm">
            <div class="filter-row">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Buscar</label>
                    <input type="text" name="buscar" value="{{ buscar }}" 
                           placeholder="Presupuesto, √≠tem, referencia..." 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">M√©todo de Pago</label>
                    <select name="metodo_pago" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- Todos --</option>
                        {% for metodo in metodos_pago %}
                        <option value="{{ metodo.0 }}" {% if metodo_pago == metodo.0 %}selected{% endif %}>
                            {{ metodo.1 }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Presupuesto</label>
                    <select name="presupuesto_id" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- Todos --</option>
                        {% for presupuesto in presupuestos_cerrados %}
                        <option value="{{ presupuesto.id }}" {% if presupuesto_id == presupuesto.id|stringformat:"s" %}selected{% endif %}>
                            {{ presupuesto.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Fecha Desde</label>
                    <input type="date" name="fecha_desde" value="{{ fecha_desde }}" 
                           style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Fecha Hasta</label>
                    <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" 
                           style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <button type="submit" style="background: #4facfe; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 5px; cursor: pointer;">
                        Filtrar
                    </button>
                    <a href="{% url 'presupuestos:lista_transacciones_completa' %}" 
                       style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border-radius: 5px; text-decoration: none;">
                        Limpiar
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Lista de transacciones -->
    <div style="margin-top: 2rem;">
        {% if page_obj.object_list %}
            {% for transaccion in page_obj.object_list %}
            <div class="transaction-item">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 1.1rem; color: #1e40af;">
                                {{ transaccion.presupuesto.nombre }}
                            </strong>
                            {% if transaccion.presupuesto.estado == 'cerrado' %}
                            <span class="badge-cerrado">Cerrado</span>
                            {% else %}
                            <span class="badge-abierto">Abierto</span>
                            {% endif %}
                        </div>
                        
                        <div style="color: #6b7280; margin-bottom: 0.5rem;">
                            <strong>√çtem:</strong> {{ transaccion.item_presupuesto.nombre }}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                            <div>
                                <strong style="color: #4facfe;">Monto:</strong><br>
                                <span style="font-size: 1.25rem; font-weight: 700; color: #10b981;">
                                    ${{ transaccion.monto|floatformat:0 }}
                                </span>
                            </div>
                            <div>
                                <strong style="color: #4facfe;">Fecha:</strong><br>
                                {{ transaccion.fecha_pago|date:"d/m/Y" }}
                            </div>
                            <div>
                                <strong style="color: #4facfe;">M√©todo:</strong><br>
                                {{ transaccion.get_metodo_pago_display }}
                            </div>
                            <div>
                                <strong style="color: #4facfe;">Referencia:</strong><br>
                                {{ transaccion.referencia|default:"-" }}
                            </div>
                        </div>
                        
                        {% if transaccion.observaciones %}
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 5px;">
                            <strong style="color: #6b7280;">Observaciones:</strong><br>
                            {{ transaccion.observaciones }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div style="margin-left: 1rem;">
                        <div class="action-buttons">
                            <a href="{% url 'presupuestos:detalle_transaccion_completa' transaccion.pk %}" class="btn-small btn-view">
                                Ver
                            </a>
                            <a href="{% url 'presupuestos:editar_transaccion_completa' transaccion.pk %}" class="btn-small btn-edit">
                                Editar
                            </a>
                            <a href="{% url 'presupuestos:eliminar_transaccion_completa' transaccion.pk %}" class="btn-small btn-delete">
                                Eliminar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Paginaci√≥n -->
            {% if page_obj.has_other_pages %}
            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                <div style="display: flex; gap: 0.5rem;">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if buscar %}&buscar={{ buscar }}{% endif %}{% if metodo_pago %}&metodo_pago={{ metodo_pago }}{% endif %}" 
                       style="padding: 0.5rem 0.75rem; background: #4facfe; color: white; border-radius: 5px; text-decoration: none;">
                        ‚Üê Anterior
                    </a>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <span style="padding: 0.5rem 0.75rem; background: #1e40af; color: white; border-radius: 5px;">
                            {{ num }}
                        </span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if buscar %}&buscar={{ buscar }}{% endif %}{% if metodo_pago %}&metodo_pago={{ metodo_pago }}{% endif %}" 
                           style="padding: 0.5rem 0.75rem; background: #e5e7eb; color: #374151; border-radius: 5px; text-decoration: none;">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if buscar %}&buscar={{ buscar }}{% endif %}{% if metodo_pago %}&metodo_pago={{ metodo_pago }}{% endif %}" 
                       style="padding: 0.5rem 0.75rem; background: #4facfe; color: white; border-radius: 5px; text-decoration: none;">
                        Siguiente ‚Üí
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">No hay transacciones registradas</h3>
                <p style="color: #9ca3af; margin-bottom: 1.5rem;">
                    Comience registrando una nueva transacci√≥n para asignar pagos a presupuestos cerrados.
                </p>
                <a href="{% url 'presupuestos:crear_transaccion_general' %}" class="btn-new">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Registrar Primera Transacci√≥n
                </a>
            </div>
        {% endif %}
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar URL cuando cambien filtros (opcional)
    const filterForm = document.getElementById('filterForm');
    const inputs = filterForm.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            filterForm.submit();
        });
    });
});
</script>
{% endblock %}