{% extends 'presupuestos/base.html' %}

{% block title %}Lista de Presupuestos{% endblock %}

{% block content %}
<main class="container">
    <section class="budget-list">
        <div class="header">
            <h1>Módulo de presupuestos</h1>
            <p>Gestión de presupuestos</p>
        </div>
    
        <div class="card main-content-card">
            <!-- Filtros y búsqueda -->
            <form method="GET" action="{% url 'presupuestos:lista' %}" class="filter-search-form">
                <!-- Filtro por Estado -->
                <div class="filter-group">
                    <label for="id_filtro_estado">Estado:</label>
                    {{ filter_form.estado }}
                </div>

                <!-- Nuevo Filtro por Usuario -->
                <div class="filter-group">
                    <label for="usuario">Usuario:</label>
                    <select name="usuario" id="usuario" class="form-input">
                        <option value="">Todos los usuarios</option>
                        {% for usuario in usuarios %}
                        <option value="{{ usuario.username }}" {% if usuario_filtro == usuario.username %}selected{% endif %}>
                            {{ usuario.get_full_name|default:usuario.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Búsqueda por Texto -->
                <div class="filter-group search-group">
                    <label for="id_buscar">Buscar:</label>
                    {{ filter_form.buscar }}
                </div>

                <!-- Botones de Filtro -->
                <button type="submit" class="btn-clear-filter btn-apply-filter">Aplicar Filtros</button>
                <a href="{% url 'presupuestos:lista' %}" class="btn-clear-filter">Limpiar Todo</a>
            </form>
            
            <!-- Botones de acción -->
            <div class="actions-row">
                <div class="export-buttons-group">
                    <a href="{% url 'presupuestos:exportar_excel' %}?{{ request.GET.urlencode }}" class="btn-action btn-excel">REPORTE EXCEL</a>
                    <a href="{% url 'presupuestos:exportar_pdf' %}?{{ request.GET.urlencode }}" class="btn-action btn-delete">REPORTE PDF</a>
                    
                    <!-- NUEVO BOTÓN: COMPARAR PRESUPUESTO -->
                     <a href="{% url 'presupuestos:comparar_presupuesto' %}" class="btn-action" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        COMPARAR PRESUPUESTO
                    </a>
                    
                    <a href="{% url 'presupuestos:dashboard' %}" class="btn-action" style="background-color: #6b7280;">
                        VOLVER AL DASHBOARD
                    </a>
                </div>
    
                <a href="{% url 'presupuestos:crear' %}" class="action-button create-button">
                     AGREGAR PRESUPUESTO
                </a>
            </div>
    
            <!-- Tabla de presupuestos -->
            <div class="table-wrapper">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Creado Por</th>
                            <th>Fecha Creación</th>
                            <th>Fecha Límite</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Periodo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for presupuesto in page_obj %}
                        <tr>
                            <td class="product-name">{{ presupuesto.nombre }}</td>
                            <td>{{ presupuesto.creado_por }}</td>
                            <td>{{ presupuesto.fecha_creacion|date:"Y-m-d" }}</td>
                            <td>{{ presupuesto.fecha_limite|date:"Y-m-d" }}</td>
                            <td class="price-value">${{ presupuesto.total|floatformat:0 }}</td>
                            <td>
                                <span class="category-badge {% if presupuesto.estado == 'abierto' %}category-active{% else %}category-inactive{% endif %}">
                                    {{ presupuesto.get_estado_display }}
                                </span>
                            </td>
                            <td>{{ presupuesto.periodo }}</td>
                            <td class="action-buttons-cell">
                                <a href="{% url 'presupuestos:detalle' presupuesto.pk %}" class="icon-button view-button" title="Gestionar Ítems">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </a>
                                
                                <!-- Nuevo botón de Editar -->
                                <a href="{% url 'presupuestos:editar' presupuesto.pk %}" class="icon-button edit-button" title="Editar Presupuesto">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </a>

                                {% if presupuesto.estado == 'abierto' %}
                                <button type="button" class="icon-button warning-button" title="Cerrar Presupuesto" onclick="cerrarPresupuesto({{ presupuesto.pk }}, '{{ presupuesto.nombre }}')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                </button>
                                {% endif %}
                                
                                <!-- Botón de Eliminar solo para presupuestos abiertos -->
                                {% if presupuesto.estado == 'abierto' %}
                                <button type="button" class="icon-button delete-button" title="Eliminar Presupuesto" onclick="eliminarPresupuesto({{ presupuesto.pk }}, '{{ presupuesto.nombre }}')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 2rem;">
                                No hay presupuestos disponibles.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación -->
            {% if page_obj.has_other_pages %}
            <div class="pagination-container">
                <nav aria-label="Navegación de páginas">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true">&laquo;</span>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Siguiente">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true">&raquo;</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                <span class="page-info">
                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} presupuestos)
                </span>
            </div>
            {% endif %}
        </div>
    </section>
</main>

<!-- Modal para Comparación de Presupuestos -->
<div id="modalComparacion" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Comparar Presupuesto vs Transacciones</h2>
            <span class="close-button" onclick="cerrarModalComparacion()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="formComparacion">
                <div class="form-group">
                    <label for="presupuestoComparar">Seleccionar Presupuesto:</label>
                    <select id="presupuestoComparar" class="form-input" required>
                        <option value="">-- Seleccione un presupuesto --</option>
                        {% for presupuesto in page_obj %}
                        <option value="{{ presupuesto.id }}">
                            {{ presupuesto.nombre }} - ${{ presupuesto.total|floatformat:0 }} ({{ presupuesto.get_estado_display }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label>Opciones de Comparación:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                        <label class="checkbox-group">
                            <input type="checkbox" id="mostrarDetalles" checked>
                            <span>Mostrar detalles por ítem</span>
                        </label>
                        <label class="checkbox-group">
                            <input type="checkbox" id="mostrarGrafico" checked>
                            <span>Mostrar gráfico comparativo</span>
                        </label>
                        <label class="checkbox-group">
                            <input type="checkbox" id="soloCerrados">
                            <span>Solo presupuestos cerrados</span>
                        </label>
                        <label class="checkbox-group">
                            <input type="checkbox" id="exportarResultados">
                            <span>Exportar resultados</span>
                        </label>
                    </div>
                </div>
                
                <div id="resultadoComparacion" style="display: none; margin-top: 2rem;">
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border-left: 4px solid #8b5cf6;">
                        <h3 style="color: #8b5cf6; margin-bottom: 1rem;">Resultados de la Comparación</h3>
                        <div id="comparacionContenido">
                            <!-- Aquí se cargarán los resultados -->
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="back-button" onclick="cerrarModalComparacion()">Cancelar</button>
            <button type="button" class="save-button" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);" 
                    onclick="realizarComparacion()">
                Comparar Presupuesto
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cerrarPresupuesto(id, nombre) {
    Swal.fire({
        title: '¿Cerrar este presupuesto?',
        text: `Una vez cerrado "${nombre}", no podrás agregar ni modificar ítems.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f59e0b',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, ¡Cerrar!',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/presupuestos/${id}/cerrar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('¡Cerrado!', data.message, 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Ocurrió un error al cerrar el presupuesto', 'error');
            });
        }
    });
}

function eliminarPresupuesto(id, nombre) {
    Swal.fire({
        title: `¿Eliminar el presupuesto "${nombre}"?`,
        text: "¡Esta acción no se puede revertir!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, ¡eliminar!',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/presupuestos/${id}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('¡Eliminado!', data.message, 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.error, 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Ocurrió un error al eliminar el presupuesto', 'error');
            });
        }
    });
}

// Funciones para el modal de comparación
function mostrarModalComparacion() {
    document.getElementById('modalComparacion').style.display = 'flex';
}

function cerrarModalComparacion() {
    document.getElementById('modalComparacion').style.display = 'none';
    document.getElementById('resultadoComparacion').style.display = 'none';
}

function realizarComparacion() {
    const presupuestoId = document.getElementById('presupuestoComparar').value;
    
    if (!presupuestoId) {
        Swal.fire({
            icon: 'warning',
            title: 'Seleccione un presupuesto',
            text: 'Debe seleccionar un presupuesto para comparar',
            confirmButtonColor: '#f59e0b'
        });
        return;
    }
    
    const mostrarDetalles = document.getElementById('mostrarDetalles').checked;
    const mostrarGrafico = document.getElementById('mostrarGrafico').checked;
    const exportarResultados = document.getElementById('exportarResultados').checked;
    
    // Mostrar loading
    Swal.fire({
        title: 'Comparando presupuesto...',
        text: 'Analizando transacciones y calculando diferencias',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Llamar a la API de comparación
    fetch(`/presupuestos/api/comparar-presupuesto/${presupuestoId}/`)
        .then(response => response.json())
        .then(data => {
            Swal.close();
            
            if (data.error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error,
                    confirmButtonColor: '#ef4444'
                });
                return;
            }
            
            // Mostrar resultados en el modal
            mostrarResultadosComparacion(data);
            document.getElementById('resultadoComparacion').style.display = 'block';
            
            // Scroll a resultados
            document.getElementById('resultadoComparacion').scrollIntoView({ behavior: 'smooth' });
            
            // Si se seleccionó exportar, ofrecer descarga
            if (exportarResultados) {
                setTimeout(() => {
                    Swal.fire({
                        title: '¿Exportar resultados?',
                        text: 'Puede exportar los resultados a Excel o PDF',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#10b981',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'Exportar a Excel',
                        cancelButtonText: 'Cancelar',
                        showDenyButton: true,
                        denyButtonText: 'Exportar a PDF',
                        denyButtonColor: '#ef4444'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Exportar a Excel
                            window.open(`/presupuestos/${presupuestoId}/exportar-comparacion-excel/`, '_blank');
                        } else if (result.isDenied) {
                            // Exportar a PDF
                            window.open(`/presupuestos/${presupuestoId}/exportar-comparacion-pdf/`, '_blank');
                        }
                    });
                }, 1000);
            }
        })
        .catch(error => {
            Swal.close();
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo realizar la comparación',
                confirmButtonColor: '#ef4444'
            });
            console.error('Error:', error);
        });
}

function mostrarResultadosComparacion(data) {
    const contenido = document.getElementById('comparacionContenido');
    
    let html = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
                <div style="font-size: 0.875rem; color: #6b7280;">Total Presupuestado</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;">$${data.total_presupuestado.toLocaleString()}</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
                <div style="font-size: 0.875rem; color: #6b7280;">Total Ejecutado</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: ${data.total_ejecutado <= data.total_presupuestado ? '#10b981' : '#ef4444'}">
                    $${data.total_ejecutado.toLocaleString()}
                </div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb;">
                <div style="font-size: 0.875rem; color: #6b7280;">Diferencia</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: ${data.diferencia >= 0 ? '#10b981' : '#ef4444'}">
                    $${data.diferencia.toLocaleString()}
                </div>
            </div>
        </div>
        
        <div style="margin-top: 1rem;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Estado del Presupuesto:</div>
            <div style="padding: 0.75rem; background: ${data.estado === 'Dentro del presupuesto' ? '#d1fae5' : '#fee2e2'}; 
                 border-radius: 8px; color: ${data.estado === 'Dentro del presupuesto' ? '#065f46' : '#991b1b'};">
                <strong>${data.estado}</strong> - ${data.mensaje}
            </div>
        </div>
    `;
    
    if (data.mostrar_detalles && data.items && data.items.length > 0) {
        html += `
            <div style="margin-top: 2rem;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 1rem;">Detalle por Ítem:</div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb;">Ítem</th>
                                <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb;">Presupuestado</th>
                                <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb;">Ejecutado</th>
                                <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb;">Diferencia</th>
                                <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        data.items.forEach(item => {
            const estadoColor = item.diferencia >= 0 ? '#10b981' : '#ef4444';
            const estadoTexto = item.diferencia >= 0 ? 'Bien' : 'Sobregiro';
            
            html += `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 0.75rem;">${item.nombre}</td>
                    <td style="padding: 0.75rem; text-align: right;">$${item.presupuestado.toLocaleString()}</td>
                    <td style="padding: 0.75rem; text-align: right;">$${item.ejecutado.toLocaleString()}</td>
                    <td style="padding: 0.75rem; text-align: right; color: ${estadoColor};">$${item.diferencia.toLocaleString()}</td>
                    <td style="padding: 0.75rem; text-align: center;">
                        <span style="padding: 0.25rem 0.5rem; background: ${estadoColor}; color: white; border-radius: 12px; font-size: 0.75rem;">
                            ${estadoTexto}
                        </span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    contenido.innerHTML = html;
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('modalComparacion');
    if (event.target === modal) {
        cerrarModalComparacion();
    }
}

// Función para mostrar información de los filtros aplicados
document.addEventListener('DOMContentLoaded', function() {
    const filtrosAplicados = [];
    
    {% if estado_filter %}
    filtrosAplicados.push('Estado: {{ estado_filter }}');
    {% endif %}
    
    {% if usuario_filtro %}
    filtrosAplicados.push('Usuario: {{ usuario_filtro }}');
    {% endif %}
    
    {% if buscar %}
    filtrosAplicados.push('Búsqueda: {{ buscar }}');
    {% endif %}
    
    if (filtrosAplicados.length > 0) {
        console.log('Filtros aplicados:', filtrosAplicados.join(', '));
    }
});
</script>

<!-- Estilos para el modal de comparación -->
<style>
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.modal-header h2 {
    color: #8b5cf6;
    margin: 0;
    font-size: 1.5rem;
}

.close-button {
    color: #9ca3af;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
}

.close-button:hover {
    color: #374151;
}

.modal-body {
    margin-bottom: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-group span {
    font-size: 0.875rem;
    color: #374151;
}
</style>
{% endblock %}